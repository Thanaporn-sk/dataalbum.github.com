<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Sää</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/jumbotron-narrow.css" rel="stylesheet">
    
	<!-- Custom styles for this app -->
    <link href="css/nv.d3.css" rel="stylesheet">
    
    <!-- Climacons Font -->
    <link href="css/climacons-font.css" rel="stylesheet">

    <!-- Icomoon Font -->
    <link href="css/icomoon-font.css" rel="stylesheet">

	<!-- Custom styles for this app -->
    <link href="css/custom.css" rel="stylesheet">
        
  </head>

  <body>
	<!-- map background -->
	<div id="mapwrapper"><div id="map"></div></div> 

	<!-- bootstrap -->
    <div class="container-narrow">
      <div class="header">
        <ul class="nav">
          <li><input class="h3 block-jumbotron" id="manualLocation" type="text" style="border: none" placeholder="Kirjoita paikkakunta"></li>
        </ul>
        <h3 class="muted" id="address"></h3>
	
      </div>
      <div class="row marketing">
        <div class="col-lg-12 block" id="forecastMain">
        </div>
      </div>

      <div class="row marketing">
        <div class="col-lg-12 block" id="forecastChart2">
        	<svg style="height:240px"></svg>
        </div>
        <div class="col-lg-12 block" id="observationChart2">
        	<svg style="height:240px"></svg>
        </div>

<!--        <div class="col-lg-6" id="observation">
    </div> -->
      </div>

      <div class="footer">
        <p>By <a href="mailto:heikkipiipponen@ovi.com">Heikki Piipponen</a></p>
      </div>

    </div> <!-- /container -->
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->


	<script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>

	<script src="js/getlocation.js"></script>
	<script src="js/metolib.js"></script>
	<script src="js/weathersymbols.js"></script>

	<script src="js/utils-1.0.0-min.js"></script>
	<script src="js/wfsrequestparser-1.0.0-min.js"></script>
	<script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
		
	<!-- NVD3 javascripts -->
	<script src="js/nv.d3.js"></script>
	
	<!-- custom multiChart.js, added bars.forceY, line 201  
	<script src="src/models/multiChart.js"></script> -->
    
    <script>
    
    var server_url = "http://data.fmi.fi/fmi-apikey/516006c7-30ef-4474-97ea-76f7bf4ae01c/wfs";
    
    $(function() {
		//geoLocation();
		geoLocation();
	});

	$("#manualLocation").keypress(function(event) {
		if (event.which == 13) {
	    	//event.preventDefault();
			value = $("#manualLocation").val(); 
			console.log(value)
			getPlace(value);
	    }
	});
	
	function showForecastChart(dataset) {
		
		console.log(dataset)
		
		dataset.locations[0].data.temperature.timeValuePairs.shift();
		dataset.locations[0].data.precipitation1h.timeValuePairs.shift();
		
		/*
		 * Forecast multi line chart
		 * Data: Temperature, Precipitation
		 */
		
		var data2 = [
		{
			"key": "Sademäärä",
			"type": "bar",
			"values": dataset.locations[0].data.precipitation1h.timeValuePairs,
			"yAxis": 2
		},
		{
			"key": "Lämpötila",
			"type": "line",
			"values": dataset.locations[0].data.temperature.timeValuePairs,
			"yAxis": 1
		}
		]
		.map(function(series) {
			series.values = series.values.map(function(d) { return {x: d.time, y: d.value } });
			return series;
		});

		console.log(data2)
		
		nv.addGraph(function() {
		    var chart = nv.models.multiChart()
		        //.margin({top: 30, right: 60, bottom: 50, left: 70})
		        //.x(function(d) { return d })
		        .color(d3.scale.category10().range());
			
			chart.showLegend(false);
		    
		    chart.xAxis
		        .tickFormat(function (d) { return d3.time.format('%H')(new Date(d)) + ":00" });
		
		    chart.yAxis1
		        .tickFormat(d3.format(',.0f'));
		
		    chart.yAxis2
		        .tickFormat(d3.format(',.1f'));
		    
		    //chart.bars1.forceY([0]);
		
		    d3.select('#forecastChart2 svg')
		        .datum(data2)
		      .transition().duration(500).call(chart);
			
			forecastChart2 = chart;
		    
		    return chart;
		});
	}

	/*
	 * Observation chart
	 */
	function showObservationChart(dataset) {
		
		console.log(dataset)
		
		var temperature = dataset.locations[0].data.t2m.timeValuePairs;
		var windSpeed = dataset.locations[0].data.ws_10min.timeValuePairs;
		var windGust = dataset.locations[0].data.wg_10min.timeValuePairs;
		var windDirection = dataset.locations[0].data.wd_10min.timeValuePairs;
		var rh = dataset.locations[0].data.rh.timeValuePairs;
		var td = dataset.locations[0].data.td.timeValuePairs;
		var r_1h = dataset.locations[0].data.r_1h.timeValuePairs;
		var r_10min = dataset.locations[0].data.ri_10min.timeValuePairs;
		var snow = dataset.locations[0].data.snow_aws.timeValuePairs;
		var pressure = dataset.locations[0].data.p_sea.timeValuePairs;
		var visibility = dataset.locations[0].data.vis.timeValuePairs;	
		
		
		/*
		 * Observation multi chart
		 * Data: Temperature, Precipitation
		 */
		
		var observationData = [
		{
			"key": "Sademäärä",
			"type": "bar",
			"values": r_1h,
			"yAxis": 2
		},
		{
			"key": "Lämpötila",
			"type": "line",
			"values": temperature,
			"yAxis": 1
		}
		]
		.map(function(series) {
			series.values = series.values.map(function(d) { return {x: d.time, y: d.value } });
			return series;
		});

		console.log(observationData)
		
		nv.addGraph(function() {
		    var chart = nv.models.multiChart()
		        //.margin({top: 30, right: 60, bottom: 50, left: 70})
		        //.x(function(d) { return d })
		        .color(d3.scale.category10().range());
			
			chart.showLegend(false);
		    
		    chart.xAxis
		        .tickFormat(function (d) { return d3.time.format('%H')(new Date(d)) + ":00" });
		
		    chart.yAxis1
		        .tickFormat(d3.format(',.0f'));
		
		    chart.yAxis2
		        .tickFormat(d3.format(',.1f'));
		    
		    //chart.bars2.forceY([0]);
		    
		    d3.select('#observationChart2 svg')
		        .datum(observationData)
		      .transition().duration(500).call(chart);
			
			observation2 = chart;
		    
		    return chart;
		});
	}
		function showForecastMain(dataset,errors){

			console.log(dataset)

			//data processing
			var shiftedTemp = dataset.locations[0].data.temperature.timeValuePairs.shift();
			var shiftedPress = dataset.locations[0].data.pressure.timeValuePairs.shift();
			var shiftedSymb = dataset.locations[0].data.weathersymbol3.timeValuePairs.shift();
			
			console.log(shiftedSymb)
			
			//create header
			var header = d3.selectAll("#forecastMain");
			
			function update(data) {
				

				//header place
				var textPlace = header.selectAll("h2")
					.data(data);
				
				textPlace.enter().append("h2");
				textPlace.text(function(d){ return d.info.name; });

				//textPlace.enter().append("h1");
				//textPlace.text(function(d){ return d3.format('.0f')(d.data.temperature.timeValuePairs[0].value) + "°C"; });

				//header weather & temperature
				//add tooltip
				var weatherSymbolTemp = header.selectAll("h1")
				    .data(data);
				weatherSymbolTemp.enter().append("h1");
				weatherSymbolTemp.attr("class", function(d) { return "climacon " + symbolMap[d.data.weathersymbol3.timeValuePairs[0].value] ; });
				weatherSymbolTemp.text(function(d){ 
					return " " + d3.format('.0f')(d.data.temperature.timeValuePairs[0].value) + "°C "; });				

				//header timedate
				var textTime = header.selectAll("p")
					.data(data);

				textTime.enter().append("p").attr("class", "lead");
				textTime.text(function(d){ return d.data.temperature.timeValuePairs[0].time = d3.time.format("%d.%m.%Y %H:%M")(new Date(d.data.temperature.timeValuePairs[0].time)); });				

				textPlace.exit().remove();
				weatherSymbolTemp.exit().remove();
				textTime.exit().remove();
			}
						
			update(dataset.locations);
		}

    </script>
  </body>
</html>
